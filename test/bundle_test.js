/* env:test version:v-2025-08-25-13-19-patch-qui-ecrit-correctement-sur-memberstackpatch-qui-crit-correctement-sur-memb */
(()=>{var q=Object.defineProperty,ot=Object.defineProperties;var rt=Object.getOwnPropertyDescriptors;var R=Object.getOwnPropertySymbols;var at=Object.prototype.hasOwnProperty,it=Object.prototype.propertyIsEnumerable;var B=(t,e,n)=>e in t?q(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,h=(t,e)=>{for(var n in e||(e={}))at.call(e,n)&&B(t,n,e[n]);if(R)for(var n of R(e))it.call(e,n)&&B(t,n,e[n]);return t},J=(t,e)=>ot(t,rt(e));var st=(t,e)=>{for(var n in e)q(t,n,{get:e[n],enumerable:!0})};var lt=(()=>{let t=[0],e=0,n=50;for(let o=1;o<35;o+=1)e+=n,t.push(e),n+=10;return t})(),ct={QUESTION_COUNT:20,XP_PER_GOOD:10,ADVANCED_MULT:1.5,LEVELS_XP_TABLE:lt,API_BASE_URL:"https://api.pokersciences.com",DEBUG:!1,VERSION:typeof window!="undefined"&&(window.PS_VERSION||window.__PS_VERSION__)||"dev"};function V(t){return t&&typeof t=="object"&&!Object.isFrozen(t)&&(Object.freeze(t),Object.getOwnPropertyNames(t).forEach(e=>{t.hasOwnProperty(e)&&V(t[e])})),t}function ut(){let t=JSON.parse(JSON.stringify(ct));return V(t)}var ft={get:ut},b=ft;var $={};st($,{$:()=>c,$$:()=>L,clamp:()=>G,default:()=>mt,log:()=>S,on:()=>v,randomNonce:()=>k,round:()=>Z,setText:()=>p,setWidth:()=>P,toggle:()=>X});function c(t,e=document){return e.querySelector(t)}function L(t,e=document){return Array.from(e.querySelectorAll(t))}function v(t,e,n){t&&t.addEventListener(e,n)}function p(t,e){t&&(t.textContent=String(e))}function P(t,e){if(!t)return;let n=Math.max(0,Math.min(100,Number(e)||0));t.style.width=`${n}%`}function X(t,e){t&&(t.style.display=e?"":"none")}function G(t,e,n){return Math.max(e,Math.min(n,t))}function Z(t,e=1){return e<=0?t:Math.round(t/e)*e}function S(...t){try{let{DEBUG:e}=b.get();e&&console.log("[PS-Trainer]",...t)}catch(e){}}function k(t=12){let e=new Uint8Array(t);if(typeof crypto!="undefined"&&crypto.getRandomValues)crypto.getRandomValues(e);else for(let o=0;o<t;o+=1)e[o]=Math.floor(Math.random()*256);return btoa(String.fromCharCode(...e)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"").slice(0,t)}var dt={$:c,$$:L,on:v,setText:p,setWidth:P,toggle:X,clamp:G,round:Z,log:S,randomNonce:k},mt=dt;function pt(){try{let t=Intl.DateTimeFormat().resolvedOptions().timeZone;if(t&&typeof t=="string")return t}catch(t){S("Impossible de d\xE9tecter le TZ, fallback UTC")}return"UTC"}function z(t,e){let n=typeof t=="number"?new Date(t):new Date(t);return new Intl.DateTimeFormat("en-CA",{timeZone:e,year:"numeric",month:"2-digit",day:"2-digit"}).format(n)}function Q(t){if(!t||typeof t!="string")return null;let[e,n,o]=t.split("-").map(r=>Number(r));return!Number.isFinite(e)||!Number.isFinite(n)||!Number.isFinite(o)?null:{y:e,m:n,d:o}}function yt(t,e){let n=Q(t),o=Q(e);if(!n||!o)return NaN;let r=Date.UTC(n.y,n.m-1,n.d),a=Date.UTC(o.y,o.m-1,o.d),f=Math.abs(a-r);return Math.floor(f/864e5)}function ht(t,e){return z(Date.now(),e)===t}var wt={getUserTZ:pt,toYMDInTZ:z,diffDaysYMD:yt,isTodayYMD:ht},E=wt;var A="ps_profile_v1",Y="ps_anon_id_v1",W="ps_profile_pending_until_v1",gt=8e3,F={xp_total:0,level:1,flames:0,last_play_date:null};function H(){return typeof window=="undefined"?!1:!!(window.Memberstack||window.memberstack||window.MemberStack||window.$memberstackDom&&window.$memberstackDom.getCurrentMember)}async function _t(){var t,e;try{if(window.$memberstackDom&&window.$memberstackDom.getCurrentMember){let o=await window.$memberstackDom.getCurrentMember(),r=o&&(((t=o.data)==null?void 0:t.customFields)||o.customFields)||{},a=(...i)=>{for(let l of i){let s=r[l];if(s!=null&&String(s)!=="")return s}},f=a("xp_total","xpTotal","xp","xp-total"),u=a("level","niveau"),d=a("flames","flammes"),w=a("last_play_date","lastPlayDate","last_played","lastPlayed","last-play-date"),m={};if(f!==void 0&&(m.xp_total=Number(f)||0),u!==void 0&&(m.level=Number(u)||1),d!==void 0&&(m.flames=Number(d)||0),w!==void 0){let i=w;try{i instanceof Date?i=i.toISOString().slice(0,10):typeof i=="string"&&i.includes("T")&&(i=i.slice(0,10))}catch(l){}m.last_play_date=i||null}return m}let n=window.Memberstack||window.memberstack||window.MemberStack;if(n&&typeof n.getCustomFields=="function"){let o=await n.getCustomFields()||{},r={};return o.xp_total!==void 0&&(r.xp_total=Number(o.xp_total)||0),o["xp-total"]!==void 0&&(r.xp_total=Number(o["xp-total"])||0),o.level!==void 0&&(r.level=Number(o.level)||1),o.flames!==void 0&&(r.flames=Number(o.flames)||0),o.last_play_date!==void 0&&(r.last_play_date=o.last_play_date||null),o["last-play-date"]!==void 0&&(r.last_play_date=o["last-play-date"]||null),r}if(n&&typeof n.getCurrentMember=="function"){let o=await n.getCurrentMember(),r=o&&(o.customFields||((e=o.data)==null?void 0:e.customFields))||{},a={};return r.xp_total!==void 0&&(a.xp_total=Number(r.xp_total)||0),r["xp-total"]!==void 0&&(a.xp_total=Number(r["xp-total"])||0),r.level!==void 0&&(a.level=Number(r.level)||1),r.flames!==void 0&&(a.flames=Number(r.flames)||0),r.last_play_date!==void 0&&(a.last_play_date=r.last_play_date||null),r["last-play-date"]!==void 0&&(a.last_play_date=r["last-play-date"]||null),a}return null}catch(n){return S("Memberstack indisponible (lecture), utilisation du fallback localStorage."),null}}async function xt(t){var e,n;try{let o={xp_total:t.xp_total!=null?String(t.xp_total):void 0,level:t.level!=null?String(t.level):void 0,flames:t.flames!=null?String(t.flames):void 0,last_play_date:t.last_play_date||void 0};if(window.$memberstackDom&&window.$memberstackDom.updateCurrentMember){let a={};o.flames!==void 0&&(a.flammes=o.flames),o.xp_total!==void 0&&(a["xp-total"]=o.xp_total,a.xpTotal=o.xp_total),o.last_play_date!==void 0&&(a["last-play-date"]=o.last_play_date,a.lastPlayDate=o.last_play_date),o.level!==void 0&&(a.level=o.level);try{await((n=(e=window.$memberstackDom).getCurrentMember)==null?void 0:n.call(e))}catch(f){}for(let f=0;f<3;f+=1)try{return await window.$memberstackDom.updateCurrentMember({customFields:a}),!0}catch(u){if(f===2)throw u;await new Promise(d=>setTimeout(d,400))}}let r=window.Memberstack||window.memberstack||window.MemberStack;return r?typeof r.updateCustomFields=="function"?(await r.updateCustomFields(o),!0):typeof r.setCustomFields=="function"?(await r.setCustomFields(o),!0):typeof r.updateCurrentMember=="function"?(await r.updateCurrentMember({customFields:o}),!0):!1:!1}catch(o){return S("Memberstack indisponible (\xE9criture), fallback localStorage."),!1}}async function K(){let t=h({},F),e=!1;try{let o=localStorage.getItem(A);o&&(t=h(h({},t),JSON.parse(o)))}catch(o){S("Impossible de lire le profil localStorage, on repart sur les d\xE9fauts.")}let n=!1;try{let o=Number(localStorage.getItem(W)||0);o&&Date.now()<o&&(n=!0)}catch(o){}if(!n&&H()){let o=await _t();o&&(t=h(h({},t),o),e=!0)}if(e)try{localStorage.setItem(A,JSON.stringify(t))}catch(o){}return t}async function bt(){try{let t=localStorage.getItem(A);if(t)return h(h({},F),JSON.parse(t))}catch(t){}return h({},F)}async function j(t){let e=h(h({},F),t),n=H()&&await xt(e);try{localStorage.setItem(A,JSON.stringify(e));let o=n?3e3:gt;localStorage.setItem(W,String(Date.now()+o))}catch(o){}return n}async function St(t){let e=await K(),n=h(h({},e),t);return await j(n),n}function Nt(t,e){return!!(t&&e&&t.last_play_date===e)}async function vt(){var t;try{let e=window&&(window.Memberstack||window.memberstack)||null,n=await((t=e==null?void 0:e.getMemberId)==null?void 0:t.call(e));if(n)return String(n)}catch(e){}try{let e=localStorage.getItem(Y);if(e)return e;let n=`anon_${Math.random().toString(36).slice(2,10)}`;return localStorage.setItem(Y,n),n}catch(e){return`anon_${Math.random().toString(36).slice(2,10)}`}}var Et={loadProfile:K,loadProfileFast:bt,saveProfile:j,patchProfile:St,isTodayCredited:Nt,getUserId:vt},x=Et;async function Mt(t,e={},n=8e3){let o=new AbortController,r=setTimeout(()=>o.abort(),n);try{return await fetch(t,J(h({},e),{signal:o.signal}))}finally{clearTimeout(r)}}async function tt(t,{timeoutMs:e=8e3,retry:n=1}={}){let o=async()=>{let r=await Mt(t,{method:"GET"},e);if(!r.ok)throw new Error(`HTTP ${r.status}`);return r.json()};try{return await o()}catch(r){if(n>0)return S("Requ\xEAte \xE9chou\xE9e, on r\xE9essaie une fois...",t),o();throw r}}async function Tt(){let{API_BASE_URL:t}=b.get(),e=`${t}/chapters`;return tt(e,{timeoutMs:8e3,retry:1})}async function Ct({chapterId:t,limit:e}={}){if(!t)throw new Error("chapterId est requis");let n=b.get(),o=Number(e)||n.QUESTION_COUNT,r=k(),a=`${n.API_BASE_URL}/chapters/${encodeURIComponent(t)}/questions?limit=${encodeURIComponent(o)}&nonce=${encodeURIComponent(r)}`,f=await tt(a,{timeoutMs:8e3,retry:1});return Array.isArray(f)?f:[]}var It={getChapters:Tt,getQuestions:Ct},D=It;function et(t){let{LEVELS_XP_TABLE:e}=b.get(),n=Math.max(0,Number(t)||0),o=1;for(let r=0;r<e.length;r+=1)n>=e[r]&&(o=r+1);return Math.max(1,Math.min(e.length,o))}function Pt(t){let{LEVELS_XP_TABLE:e}=b.get(),n=Math.max(0,Number(t)||0),o=et(n),r=o-1,a=e[r],f=e[Math.min(r+1,e.length-1)],u=o===e.length,d=n-a,w=u?0:Math.max(0,f-n),m=u?1:Math.max(1,f-a),i=Math.max(0,Math.min(100,Math.round(d/m*100)));return{currentLevel:o,xpInLevel:d,xpToNext:w,percent:i}}function Dt({goodCount:t,advanced:e,flames:n}){let{XP_PER_GOOD:o,ADVANCED_MULT:r}=b.get(),a=(Number(t)||0)*o,f=e?r:1,u=(Number(n)||0)===0?1:Math.max(1,Number(n)),d=Math.round(a*f*u);return{base:a,multMode:f,multFlames:u,total:d}}function Lt(t,e){if(!t||!e)return!1;let n=f=>{let[u,d,w]=String(f).split("-").map(m=>Number(m));return Date.UTC(u,(d||1)-1,w||1)},o=n(t),r=n(e);return Math.floor(Math.abs(r-o)/864e5)>=2}function kt(t,e){if(!t||!e||t.last_play_date===e)return t;let n=h({},t);return n.flames=Math.max(0,Number(n.flames)||0)+1,n.last_play_date=e,n}var At={levelFromXP:et,progressInLevel:Pt,sessionXP:Dt,shouldResetFlames:Lt,applyDailyFlame:kt},N=At;var g=null;function Ft(t,e){let n=Date.now();g={index:0,total:0,goodCount:0,mode:e==="advanced",chapterId:t||null,startedAt:n}}function $t(t){g&&t&&(g.goodCount+=1)}function Ot(){g&&(g.index+=1)}function Ut(t){g&&(g.total=Math.max(0,Number(t)||0))}function Rt(){return g?h({},g):null}function Bt(t){if(!g)return null;let e=Date.now(),n={goodCount:g.goodCount,total:g.total,advanced:!!g.mode,chapterTitle:t||"",startedAt:g.startedAt,endedAt:e};try{sessionStorage.setItem("ps_session_summary_v1",JSON.stringify(n))}catch(r){}let o=h({},n);return g=null,o}var qt={start:Ft,answer:$t,next:Ot,setTotal:Ut,getState:Rt,finish:Bt},M=qt;var nt="[data-trainer-flames]";async function Jt(){let t=c(nt);if(t)try{let e=await x.loadProfileFast();p(t,Number(e.flames)||0),t.setAttribute("data-ready","1")}catch(e){p(t,"0"),t.setAttribute("data-ready","1")}}async function Vt(){let t=c(nt);if(!t)return;let e=await x.loadProfile(),n=E.getUserTZ(),o=E.toYMDInTZ(Date.now(),n);Number(e.flames)>0&&N.shouldResetFlames(e.last_play_date,o)&&await x.patchProfile({flames:0});let r=await x.loadProfile();p(t,Number(r.flames)||0),t.setAttribute("data-ready","1")}var Xt={init:Jt,refresh:Vt},T=Xt;function Gt(){try{let t=sessionStorage.getItem("ps_session_summary_v1");return t?JSON.parse(t):null}catch(t){return null}}async function Zt(){let t=c("[data-trainer-level-name]"),e=c("[data-trainer-level-bar]"),n=c("[data-trainer-level-fill]"),o=c("[data-trainer-level-percent]"),r=c("[data-trainer-play]"),a=c('[data-mode="simple"]'),f=c('[data-mode="advanced"]');if(!t&&!e&&!r)return;let u=await x.loadProfile(),{currentLevel:d,percent:w}=N.progressInLevel(u.xp_total);p(t,`Niveau ${d}`),P(n,w),p(o,`${w}%`);let m=[];try{m=await D.getChapters()}catch(s){}let i=c("[data-trainer-chapters]");if(i&&i.tagName==="SELECT")i.innerHTML="",m.forEach(s=>{let y=document.createElement("option");y.value=s.id,y.textContent=s.title||s.slug||s.id,i.appendChild(y)});else{let s=c("[data-trainer-chapters-list]");s&&(s.innerHTML="",m.forEach(y=>{let _=document.createElement("div");_.setAttribute("data-chapter-id",y.id),_.textContent=y.title||y.slug||y.id,s.appendChild(_)}))}let l="simple";v(a,"click",()=>{l="simple"}),v(f,"click",()=>{l="advanced"}),v(r,"click",()=>{let s=null;if(i&&i.tagName==="SELECT")s=i.value||null;else{let y=c("[data-trainer-chapters-list] [data-chapter-id].selected");s=y?y.getAttribute("data-chapter-id"):null}!s&&m[0]&&(s=m[0].id);try{sessionStorage.setItem("ps_lobby_choice_v1",JSON.stringify({chapterId:s,mode:l}))}catch(y){}window.location.href="/trainer/questions"})}async function Qt(){let t=c("[data-q-stem]"),e=L("[data-q-choice]"),n=c("[data-q-feedback]"),o=c("[data-q-correct]"),r=c("[data-q-next]");if(!t&&!r)return;let a=null;try{a=JSON.parse(sessionStorage.getItem("ps_lobby_choice_v1"))}catch(l){}if(!a||!a.chapterId){window.location.href="/trainer/lobby";return}let f=b.get();M.start(a.chapterId,a.mode);let u=[];try{u=await D.getQuestions({chapterId:a.chapterId,limit:f.QUESTION_COUNT})}catch(l){u=[]}if(!Array.isArray(u)||u.length===0){window.location.href="/trainer/lobby";return}M.setTotal(u.length);let d=0,w=!1;function m(l){if(!l)return;p(t,l.stem||"");let s=Array.isArray(l.choices)?l.choices:[];["A","B","C","D"].forEach((_,C)=>{let U=document.querySelector(`[data-q-choice="${_}"]`);U&&p(U,s[C]||"")}),n&&(n.style.display="none"),o&&p(o,""),w=!1}function i(l,s){var y;if(n){if(n.style.display="",p(n,s?"Bonne r\xE9ponse \u2705":"Mauvaise r\xE9ponse \u274C"),o){let _=Number(l.correctIndex),C=Array.isArray(l.choices)?l.choices:[];p(o,`Solution: ${(y=C[_])!=null?y:""}`)}w=!0}}["A","B","C","D"].forEach((l,s)=>{let y=document.querySelector(`[data-q-choice="${l}"]`);v(y,"click",()=>{if(w)return;let _=u[d],C=Number(_.correctIndex)===s;M.answer(C),i(_,C)})}),v(r,"click",()=>{var l;if(w){if(d+=1,M.next(),d>=u.length){let s=((l=u[0])==null?void 0:l.chapterTitle)||"";M.finish(s),window.location.href="/trainer/results";return}m(u[d])}}),m(u[d])}async function zt(){let t=c("[data-r-score]"),e=c("[data-r-xp-base]"),n=c("[data-r-mult-flames]"),o=c("[data-r-mult-mode]"),r=c("[data-r-xp-total]"),a=c("[data-trainer-level-name]"),f=c("[data-trainer-level-fill]"),u=c("[data-trainer-level-percent]");if(!t&&!r&&!a)return;let d=Gt();if(!d){window.location.href="/trainer/lobby";return}let w=E.getUserTZ(),m=E.toYMDInTZ(Date.now(),w),i=await x.loadProfile();N.shouldResetFlames(i.last_play_date,m)&&(i=await x.patchProfile({flames:0})),x.isTodayCredited(i,m)||(i=await x.patchProfile({flames:Math.max(0,Number(i.flames)||0)+1,last_play_date:m}));let l=N.sessionXP({goodCount:d.goodCount,advanced:d.advanced,flames:i.flames}),s=Math.max(0,Number(i.xp_total)||0)+l.total,y=N.levelFromXP(s);i=await x.patchProfile({xp_total:s,level:y}),p(t,`${d.goodCount}/${d.total}`),p(e,`${l.base}`),p(n,`\xD7${l.multFlames}`),p(o,`\xD7${l.multMode}`),p(r,`${l.total}`);let _=N.progressInLevel(i.xp_total);p(a,`Niveau ${_.currentLevel}`),P(f,_.percent),p(u,`${_.percent}%`)}var Yt={initLobby:Zt,initQuestions:Qt,initResults:zt},I=Yt;function Wt(){async function t(){try{await T.init(),await T.refresh()}catch(e){}try{setTimeout(()=>{T.refresh()},1500)}catch(e){}try{setTimeout(()=>{T.refresh()},4e3)}catch(e){}try{await I.initLobby()}catch(e){}try{await I.initQuestions()}catch(e){}try{await I.initResults()}catch(e){}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t):t()}var Ht={boot:Wt},O=Ht;typeof window!="undefined"&&(window.PokerSciences=window.PokerSciences||{},window.PokerSciences.Trainer={Config:b,Utils:$,Time:E,Storage:x,Data:D,Progress:N,Session:M,Navbar:T,Pages:I,Boot:O});O.boot();})();
