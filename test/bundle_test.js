/* env:test version:v-2025-08-25-11-09-test-du-lundi-matin */
(()=>{var R=Object.defineProperty,ot=Object.defineProperties;var rt=Object.getOwnPropertyDescriptors;var F=Object.getOwnPropertySymbols;var nt=Object.prototype.hasOwnProperty,at=Object.prototype.propertyIsEnumerable;var B=(t,e,o)=>e in t?R(t,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[e]=o,h=(t,e)=>{for(var o in e||(e={}))nt.call(e,o)&&B(t,o,e[o]);if(F)for(var o of F(e))at.call(e,o)&&B(t,o,e[o]);return t},q=(t,e)=>ot(t,rt(e));var it=(t,e)=>{for(var o in e)R(t,o,{get:e[o],enumerable:!0})};var st=(()=>{let t=[0],e=0,o=50;for(let r=1;r<35;r+=1)e+=o,t.push(e),o+=10;return t})(),ct={QUESTION_COUNT:20,XP_PER_GOOD:10,ADVANCED_MULT:1.5,LEVELS_XP_TABLE:st,API_BASE_URL:"https://api.pokersciences.com",DEBUG:!1,VERSION:typeof window!="undefined"&&(window.PS_VERSION||window.__PS_VERSION__)||"dev"};function V(t){return t&&typeof t=="object"&&!Object.isFrozen(t)&&(Object.freeze(t),Object.getOwnPropertyNames(t).forEach(e=>{t.hasOwnProperty(e)&&V(t[e])})),t}function lt(){let t=JSON.parse(JSON.stringify(ct));return V(t)}var ut={get:lt},b=ut;var k={};it(k,{$:()=>a,$$:()=>A,clamp:()=>J,default:()=>mt,log:()=>S,on:()=>v,randomNonce:()=>D,round:()=>Z,setText:()=>f,setWidth:()=>I,toggle:()=>X});function a(t,e=document){return e.querySelector(t)}function A(t,e=document){return Array.from(e.querySelectorAll(t))}function v(t,e,o){t&&t.addEventListener(e,o)}function f(t,e){t&&(t.textContent=String(e))}function I(t,e){if(!t)return;let o=Math.max(0,Math.min(100,Number(e)||0));t.style.width=`${o}%`}function X(t,e){t&&(t.style.display=e?"":"none")}function J(t,e,o){return Math.max(e,Math.min(o,t))}function Z(t,e=1){return e<=0?t:Math.round(t/e)*e}function S(...t){try{let{DEBUG:e}=b.get();e&&console.log("[PS-Trainer]",...t)}catch(e){}}function D(t=12){let e=new Uint8Array(t);if(typeof crypto!="undefined"&&crypto.getRandomValues)crypto.getRandomValues(e);else for(let r=0;r<t;r+=1)e[r]=Math.floor(Math.random()*256);return btoa(String.fromCharCode(...e)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"").slice(0,t)}var ft={$:a,$$:A,on:v,setText:f,setWidth:I,toggle:X,clamp:J,round:Z,log:S,randomNonce:D},mt=ft;function dt(){try{let t=Intl.DateTimeFormat().resolvedOptions().timeZone;if(t&&typeof t=="string")return t}catch(t){S("Impossible de d\xE9tecter le TZ, fallback UTC")}return"UTC"}function G(t,e){let o=typeof t=="number"?new Date(t):new Date(t);return new Intl.DateTimeFormat("en-CA",{timeZone:e,year:"numeric",month:"2-digit",day:"2-digit"}).format(o)}function Q(t){if(!t||typeof t!="string")return null;let[e,o,r]=t.split("-").map(n=>Number(n));return!Number.isFinite(e)||!Number.isFinite(o)||!Number.isFinite(r)?null:{y:e,m:o,d:r}}function pt(t,e){let o=Q(t),r=Q(e);if(!o||!r)return NaN;let n=Date.UTC(o.y,o.m-1,o.d),c=Date.UTC(r.y,r.m-1,r.d),p=Math.abs(c-n);return Math.floor(p/864e5)}function ht(t,e){return G(Date.now(),e)===t}var yt={getUserTZ:dt,toYMDInTZ:G,diffDaysYMD:pt,isTodayYMD:ht},N=yt;var Y="ps_profile_v1",z="ps_anon_id_v1",O={xp_total:0,level:1,flames:0,last_play_date:null};function H(){return typeof window!="undefined"&&(window.Memberstack||window.memberstack)}async function gt(){var t;try{let e=window.Memberstack||window.memberstack;if(!e)return null;let o=await((t=e.getCustomFields)==null?void 0:t.call(e))||{};return{xp_total:Number(o.xp_total)||0,level:Number(o.level)||1,flames:Number(o.flames)||0,last_play_date:o.last_play_date||null}}catch(e){return S("Memberstack indisponible (lecture), utilisation du fallback localStorage."),null}}async function xt(t){var e;try{let o=window.Memberstack||window.memberstack;if(!o)return!1;let r={xp_total:String(t.xp_total||0),level:String(t.level||1),flames:String(t.flames||0),last_play_date:t.last_play_date||null};return await((e=o.updateCustomFields)==null?void 0:e.call(o,r)),!0}catch(o){return S("Memberstack indisponible (\xE9criture), fallback localStorage."),!1}}async function W(){if(H()){let t=await gt();if(t)return h(h({},O),t)}try{let t=localStorage.getItem(Y);if(t){let e=JSON.parse(t);return h(h({},O),e)}}catch(t){S("Impossible de lire le profil localStorage, on repart sur les d\xE9fauts.")}return h({},O)}async function K(t){let e=h(h({},O),t),o=H()&&await xt(e);try{localStorage.setItem(Y,JSON.stringify(e))}catch(r){}return o}async function wt(t){let e=await W(),o=h(h({},e),t);return await K(o),o}function _t(t,e){return!!(t&&e&&t.last_play_date===e)}async function bt(){var t;try{let e=window&&(window.Memberstack||window.memberstack)||null,o=await((t=e==null?void 0:e.getMemberId)==null?void 0:t.call(e));if(o)return String(o)}catch(e){}try{let e=localStorage.getItem(z);if(e)return e;let o=`anon_${Math.random().toString(36).slice(2,10)}`;return localStorage.setItem(z,o),o}catch(e){return`anon_${Math.random().toString(36).slice(2,10)}`}}var St={loadProfile:W,saveProfile:K,patchProfile:wt,isTodayCredited:_t,getUserId:bt},w=St;async function Et(t,e={},o=8e3){let r=new AbortController,n=setTimeout(()=>r.abort(),o);try{return await fetch(t,q(h({},e),{signal:r.signal}))}finally{clearTimeout(n)}}async function j(t,{timeoutMs:e=8e3,retry:o=1}={}){let r=async()=>{let n=await Et(t,{method:"GET"},e);if(!n.ok)throw new Error(`HTTP ${n.status}`);return n.json()};try{return await r()}catch(n){if(o>0)return S("Requ\xEAte \xE9chou\xE9e, on r\xE9essaie une fois...",t),r();throw n}}async function vt(){let{API_BASE_URL:t}=b.get(),e=`${t}/chapters`;return j(e,{timeoutMs:8e3,retry:1})}async function Nt({chapterId:t,limit:e}={}){if(!t)throw new Error("chapterId est requis");let o=b.get(),r=Number(e)||o.QUESTION_COUNT,n=D(),c=`${o.API_BASE_URL}/chapters/${encodeURIComponent(t)}/questions?limit=${encodeURIComponent(r)}&nonce=${encodeURIComponent(n)}`,p=await j(c,{timeoutMs:8e3,retry:1});return Array.isArray(p)?p:[]}var Tt={getChapters:vt,getQuestions:Nt},C=Tt;function tt(t){let{LEVELS_XP_TABLE:e}=b.get(),o=Math.max(0,Number(t)||0),r=1;for(let n=0;n<e.length;n+=1)o>=e[n]&&(r=n+1);return Math.max(1,Math.min(e.length,r))}function Mt(t){let{LEVELS_XP_TABLE:e}=b.get(),o=Math.max(0,Number(t)||0),r=tt(o),n=r-1,c=e[n],p=e[Math.min(n+1,e.length-1)],l=r===e.length,m=o-c,_=l?0:Math.max(0,p-o),y=l?1:Math.max(1,p-c),u=Math.max(0,Math.min(100,Math.round(m/y*100)));return{currentLevel:r,xpInLevel:m,xpToNext:_,percent:u}}function Pt({goodCount:t,advanced:e,flames:o}){let{XP_PER_GOOD:r,ADVANCED_MULT:n}=b.get(),c=(Number(t)||0)*r,p=e?n:1,l=(Number(o)||0)===0?1:Math.max(1,Number(o)),m=Math.round(c*p*l);return{base:c,multMode:p,multFlames:l,total:m}}function It(t,e){if(!t||!e)return!1;let o=p=>{let[l,m,_]=String(p).split("-").map(y=>Number(y));return Date.UTC(l,(m||1)-1,_||1)},r=o(t),n=o(e);return Math.floor(Math.abs(n-r)/864e5)>=2}function Ct(t,e){if(!t||!e||t.last_play_date===e)return t;let o=h({},t);return o.flames=Math.max(0,Number(o.flames)||0)+1,o.last_play_date=e,o}var Lt={levelFromXP:tt,progressInLevel:Mt,sessionXP:Pt,shouldResetFlames:It,applyDailyFlame:Ct},E=Lt;var g=null;function At(t,e){let o=Date.now();g={index:0,total:0,goodCount:0,mode:e==="advanced",chapterId:t||null,startedAt:o}}function Dt(t){g&&t&&(g.goodCount+=1)}function Ot(){g&&(g.index+=1)}function kt(t){g&&(g.total=Math.max(0,Number(t)||0))}function Ut(){return g?h({},g):null}function $t(t){if(!g)return null;let e=Date.now(),o={goodCount:g.goodCount,total:g.total,advanced:!!g.mode,chapterTitle:t||"",startedAt:g.startedAt,endedAt:e};try{sessionStorage.setItem("ps_session_summary_v1",JSON.stringify(o))}catch(n){}let r=h({},o);return g=null,r}var Ft={start:At,answer:Dt,next:Ot,setTotal:kt,getState:Ut,finish:$t},T=Ft;var et="[data-trainer-flames]";async function Bt(){let t=a(et);if(t)try{let e=await w.loadProfile();f(t,Number(e.flames)||0)}catch(e){f(t,"0")}}async function Rt(){let t=a(et);if(!t)return;let e=await w.loadProfile(),o=N.getUserTZ(),r=N.toYMDInTZ(Date.now(),o);Number(e.flames)>0&&E.shouldResetFlames(e.last_play_date,r)&&await w.patchProfile({flames:0});let n=await w.loadProfile();f(t,Number(n.flames)||0)}var qt={init:Bt,refresh:Rt},L=qt;function Vt(){try{let t=sessionStorage.getItem("ps_session_summary_v1");return t?JSON.parse(t):null}catch(t){return null}}async function Xt(){let t=a("[data-trainer-level-name]"),e=a("[data-trainer-level-bar]"),o=a("[data-trainer-level-fill]"),r=a("[data-trainer-level-percent]"),n=a("[data-trainer-play]"),c=a('[data-mode="simple"]'),p=a('[data-mode="advanced"]');if(!t&&!e&&!n)return;let l=await w.loadProfile(),{currentLevel:m,percent:_}=E.progressInLevel(l.xp_total);f(t,`Niveau ${m}`),I(o,_),f(r,`${_}%`);let y=[];try{y=await C.getChapters()}catch(i){}let u=a("[data-trainer-chapters]");if(u&&u.tagName==="SELECT")u.innerHTML="",y.forEach(i=>{let d=document.createElement("option");d.value=i.id,d.textContent=i.title||i.slug||i.id,u.appendChild(d)});else{let i=a("[data-trainer-chapters-list]");i&&(i.innerHTML="",y.forEach(d=>{let x=document.createElement("div");x.setAttribute("data-chapter-id",d.id),x.textContent=d.title||d.slug||d.id,i.appendChild(x)}))}let s="simple";v(c,"click",()=>{s="simple"}),v(p,"click",()=>{s="advanced"}),v(n,"click",()=>{let i=null;if(u&&u.tagName==="SELECT")i=u.value||null;else{let d=a("[data-trainer-chapters-list] [data-chapter-id].selected");i=d?d.getAttribute("data-chapter-id"):null}!i&&y[0]&&(i=y[0].id);try{sessionStorage.setItem("ps_lobby_choice_v1",JSON.stringify({chapterId:i,mode:s}))}catch(d){}window.location.href="/trainer/questions"})}async function Jt(){let t=a("[data-q-stem]"),e=A("[data-q-choice]"),o=a("[data-q-feedback]"),r=a("[data-q-correct]"),n=a("[data-q-next]");if(!t&&!n)return;let c=null;try{c=JSON.parse(sessionStorage.getItem("ps_lobby_choice_v1"))}catch(s){}if(!c||!c.chapterId){window.location.href="/trainer/lobby";return}let p=b.get();T.start(c.chapterId,c.mode);let l=[];try{l=await C.getQuestions({chapterId:c.chapterId,limit:p.QUESTION_COUNT})}catch(s){l=[]}if(!Array.isArray(l)||l.length===0){window.location.href="/trainer/lobby";return}T.setTotal(l.length);let m=0,_=!1;function y(s){if(!s)return;f(t,s.stem||"");let i=Array.isArray(s.choices)?s.choices:[];["A","B","C","D"].forEach((x,M)=>{let $=document.querySelector(`[data-q-choice="${x}"]`);$&&f($,i[M]||"")}),o&&(o.style.display="none"),r&&f(r,""),_=!1}function u(s,i){var d;if(o){if(o.style.display="",f(o,i?"Bonne r\xE9ponse \u2705":"Mauvaise r\xE9ponse \u274C"),r){let x=Number(s.correctIndex),M=Array.isArray(s.choices)?s.choices:[];f(r,`Solution: ${(d=M[x])!=null?d:""}`)}_=!0}}["A","B","C","D"].forEach((s,i)=>{let d=document.querySelector(`[data-q-choice="${s}"]`);v(d,"click",()=>{if(_)return;let x=l[m],M=Number(x.correctIndex)===i;T.answer(M),u(x,M)})}),v(n,"click",()=>{var s;if(_){if(m+=1,T.next(),m>=l.length){let i=((s=l[0])==null?void 0:s.chapterTitle)||"";T.finish(i),window.location.href="/trainer/results";return}y(l[m])}}),y(l[m])}async function Zt(){let t=a("[data-r-score]"),e=a("[data-r-xp-base]"),o=a("[data-r-mult-flames]"),r=a("[data-r-mult-mode]"),n=a("[data-r-xp-total]"),c=a("[data-trainer-level-name]"),p=a("[data-trainer-level-fill]"),l=a("[data-trainer-level-percent]");if(!t&&!n&&!c)return;let m=Vt();if(!m){window.location.href="/trainer/lobby";return}let _=N.getUserTZ(),y=N.toYMDInTZ(Date.now(),_),u=await w.loadProfile();E.shouldResetFlames(u.last_play_date,y)&&(u=await w.patchProfile({flames:0})),w.isTodayCredited(u,y)||(u=await w.patchProfile({flames:Math.max(0,Number(u.flames)||0)+1,last_play_date:y}));let s=E.sessionXP({goodCount:m.goodCount,advanced:m.advanced,flames:u.flames}),i=Math.max(0,Number(u.xp_total)||0)+s.total,d=E.levelFromXP(i);u=await w.patchProfile({xp_total:i,level:d}),f(t,`${m.goodCount}/${m.total}`),f(e,`${s.base}`),f(o,`\xD7${s.multFlames}`),f(r,`\xD7${s.multMode}`),f(n,`${s.total}`);let x=E.progressInLevel(u.xp_total);f(c,`Niveau ${x.currentLevel}`),I(p,x.percent),f(l,`${x.percent}%`)}var Qt={initLobby:Xt,initQuestions:Jt,initResults:Zt},P=Qt;function Gt(){document.addEventListener("DOMContentLoaded",async()=>{try{await L.init(),await L.refresh()}catch(t){}try{await P.initLobby()}catch(t){}try{await P.initQuestions()}catch(t){}try{await P.initResults()}catch(t){}})}var zt={boot:Gt},U=zt;typeof window!="undefined"&&(window.PokerSciences=window.PokerSciences||{},window.PokerSciences.Trainer={Config:b,Utils:k,Time:N,Storage:w,Data:C,Progress:E,Session:T,Navbar:L,Pages:P,Boot:U});U.boot();})();
