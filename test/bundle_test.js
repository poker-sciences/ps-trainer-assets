/* env:test version:v-2025-08-25-11-46-modification-de-loadprofile-avec-une-meilleur-connaissance-de-ms */
(()=>{var q=Object.defineProperty,ot=Object.defineProperties;var rt=Object.getOwnPropertyDescriptors;var B=Object.getOwnPropertySymbols;var nt=Object.prototype.hasOwnProperty,at=Object.prototype.propertyIsEnumerable;var R=(t,e,o)=>e in t?q(t,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[e]=o,h=(t,e)=>{for(var o in e||(e={}))nt.call(e,o)&&R(t,o,e[o]);if(B)for(var o of B(e))at.call(e,o)&&R(t,o,e[o]);return t},D=(t,e)=>ot(t,rt(e));var st=(t,e)=>{for(var o in e)q(t,o,{get:e[o],enumerable:!0})};var it=(()=>{let t=[0],e=0,o=50;for(let r=1;r<35;r+=1)e+=o,t.push(e),o+=10;return t})(),lt={QUESTION_COUNT:20,XP_PER_GOOD:10,ADVANCED_MULT:1.5,LEVELS_XP_TABLE:it,API_BASE_URL:"https://api.pokersciences.com",DEBUG:!1,VERSION:typeof window!="undefined"&&(window.PS_VERSION||window.__PS_VERSION__)||"dev"};function V(t){return t&&typeof t=="object"&&!Object.isFrozen(t)&&(Object.freeze(t),Object.getOwnPropertyNames(t).forEach(e=>{t.hasOwnProperty(e)&&V(t[e])})),t}function ct(){let t=JSON.parse(JSON.stringify(lt));return V(t)}var ut={get:ct},b=ut;var $={};st($,{$:()=>l,$$:()=>A,clamp:()=>J,default:()=>ft,log:()=>S,on:()=>N,randomNonce:()=>k,round:()=>Z,setText:()=>p,setWidth:()=>P,toggle:()=>X});function l(t,e=document){return e.querySelector(t)}function A(t,e=document){return Array.from(e.querySelectorAll(t))}function N(t,e,o){t&&t.addEventListener(e,o)}function p(t,e){t&&(t.textContent=String(e))}function P(t,e){if(!t)return;let o=Math.max(0,Math.min(100,Number(e)||0));t.style.width=`${o}%`}function X(t,e){t&&(t.style.display=e?"":"none")}function J(t,e,o){return Math.max(e,Math.min(o,t))}function Z(t,e=1){return e<=0?t:Math.round(t/e)*e}function S(...t){try{let{DEBUG:e}=b.get();e&&console.log("[PS-Trainer]",...t)}catch(e){}}function k(t=12){let e=new Uint8Array(t);if(typeof crypto!="undefined"&&crypto.getRandomValues)crypto.getRandomValues(e);else for(let r=0;r<t;r+=1)e[r]=Math.floor(Math.random()*256);return btoa(String.fromCharCode(...e)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"").slice(0,t)}var mt={$:l,$$:A,on:N,setText:p,setWidth:P,toggle:X,clamp:J,round:Z,log:S,randomNonce:k},ft=mt;function dt(){try{let t=Intl.DateTimeFormat().resolvedOptions().timeZone;if(t&&typeof t=="string")return t}catch(t){S("Impossible de d\xE9tecter le TZ, fallback UTC")}return"UTC"}function z(t,e){let o=typeof t=="number"?new Date(t):new Date(t);return new Intl.DateTimeFormat("en-CA",{timeZone:e,year:"numeric",month:"2-digit",day:"2-digit"}).format(o)}function Q(t){if(!t||typeof t!="string")return null;let[e,o,r]=t.split("-").map(n=>Number(n));return!Number.isFinite(e)||!Number.isFinite(o)||!Number.isFinite(r)?null:{y:e,m:o,d:r}}function pt(t,e){let o=Q(t),r=Q(e);if(!o||!r)return NaN;let n=Date.UTC(o.y,o.m-1,o.d),c=Date.UTC(r.y,r.m-1,r.d),d=Math.abs(c-n);return Math.floor(d/864e5)}function yt(t,e){return z(Date.now(),e)===t}var ht={getUserTZ:dt,toYMDInTZ:z,diffDaysYMD:pt,isTodayYMD:yt},E=ht;var Y="ps_profile_v1",G="ps_anon_id_v1",F={xp_total:0,level:1,flames:0,last_play_date:null};function H(){return typeof window=="undefined"?!1:!!(window.Memberstack||window.memberstack||window.MemberStack||window.$memberstackDom&&window.$memberstackDom.getCurrentMember)}async function wt(){var t,e,o,r,n,c,d,u,f,w;try{if(window.$memberstackDom&&window.$memberstackDom.getCurrentMember){let s=await window.$memberstackDom.getCurrentMember(),a=s&&(((t=s.data)==null?void 0:t.customFields)||s.customFields)||{},i={xp_total:((o=(e=a.xp_total)!=null?e:a.xpTotal)!=null?o:a.xp)||0,level:(n=(r=a.level)!=null?r:a.niveau)!=null?n:1,flames:(d=(c=a.flames)!=null?c:a.flammes)!=null?d:0,last_play_date:(f=(u=a.last_play_date)!=null?u:a.lastPlayDate)!=null?f:null};return{xp_total:Number(i.xp_total)||0,level:Number(i.level)||1,flames:Number(i.flames)||0,last_play_date:i.last_play_date||null}}let m=window.Memberstack||window.memberstack||window.MemberStack;if(m&&typeof m.getCustomFields=="function"){let s=await m.getCustomFields()||{};return{xp_total:Number(s.xp_total)||0,level:Number(s.level)||1,flames:Number(s.flames)||0,last_play_date:s.last_play_date||null}}if(m&&typeof m.getCurrentMember=="function"){let s=await m.getCurrentMember(),a=s&&(s.customFields||((w=s.data)==null?void 0:w.customFields))||{};return{xp_total:Number(a.xp_total)||0,level:Number(a.level)||1,flames:Number(a.flames)||0,last_play_date:a.last_play_date||null}}return null}catch(m){return S("Memberstack indisponible (lecture), utilisation du fallback localStorage."),null}}async function gt(t){try{let e={xp_total:String(t.xp_total||0),level:String(t.level||1),flames:String(t.flames||0),last_play_date:t.last_play_date||null};if(window.$memberstackDom&&window.$memberstackDom.updateCurrentMember){let r=D(h({},e),{flammes:e.flames,xpTotal:e.xp_total,lastPlayDate:e.last_play_date});return await window.$memberstackDom.updateCurrentMember({customFields:r}),!0}let o=window.Memberstack||window.memberstack||window.MemberStack;return o?typeof o.updateCustomFields=="function"?(await o.updateCustomFields(e),!0):typeof o.setCustomFields=="function"?(await o.setCustomFields(e),!0):typeof o.updateCurrentMember=="function"?(await o.updateCurrentMember({customFields:e}),!0):!1:!1}catch(e){return S("Memberstack indisponible (\xE9criture), fallback localStorage."),!1}}async function W(){if(H()){let t=await wt();if(t)return h(h({},F),t)}try{let t=localStorage.getItem(Y);if(t){let e=JSON.parse(t);return h(h({},F),e)}}catch(t){S("Impossible de lire le profil localStorage, on repart sur les d\xE9fauts.")}return h({},F)}async function K(t){let e=h(h({},F),t),o=H()&&await gt(e);try{localStorage.setItem(Y,JSON.stringify(e))}catch(r){}return o}async function xt(t){let e=await W(),o=h(h({},e),t);return await K(o),o}function _t(t,e){return!!(t&&e&&t.last_play_date===e)}async function bt(){var t;try{let e=window&&(window.Memberstack||window.memberstack)||null,o=await((t=e==null?void 0:e.getMemberId)==null?void 0:t.call(e));if(o)return String(o)}catch(e){}try{let e=localStorage.getItem(G);if(e)return e;let o=`anon_${Math.random().toString(36).slice(2,10)}`;return localStorage.setItem(G,o),o}catch(e){return`anon_${Math.random().toString(36).slice(2,10)}`}}var St={loadProfile:W,saveProfile:K,patchProfile:xt,isTodayCredited:_t,getUserId:bt},_=St;async function vt(t,e={},o=8e3){let r=new AbortController,n=setTimeout(()=>r.abort(),o);try{return await fetch(t,D(h({},e),{signal:r.signal}))}finally{clearTimeout(n)}}async function j(t,{timeoutMs:e=8e3,retry:o=1}={}){let r=async()=>{let n=await vt(t,{method:"GET"},e);if(!n.ok)throw new Error(`HTTP ${n.status}`);return n.json()};try{return await r()}catch(n){if(o>0)return S("Requ\xEAte \xE9chou\xE9e, on r\xE9essaie une fois...",t),r();throw n}}async function Nt(){let{API_BASE_URL:t}=b.get(),e=`${t}/chapters`;return j(e,{timeoutMs:8e3,retry:1})}async function Et({chapterId:t,limit:e}={}){if(!t)throw new Error("chapterId est requis");let o=b.get(),r=Number(e)||o.QUESTION_COUNT,n=k(),c=`${o.API_BASE_URL}/chapters/${encodeURIComponent(t)}/questions?limit=${encodeURIComponent(r)}&nonce=${encodeURIComponent(n)}`,d=await j(c,{timeoutMs:8e3,retry:1});return Array.isArray(d)?d:[]}var Mt={getChapters:Nt,getQuestions:Et},I=Mt;function tt(t){let{LEVELS_XP_TABLE:e}=b.get(),o=Math.max(0,Number(t)||0),r=1;for(let n=0;n<e.length;n+=1)o>=e[n]&&(r=n+1);return Math.max(1,Math.min(e.length,r))}function Ct(t){let{LEVELS_XP_TABLE:e}=b.get(),o=Math.max(0,Number(t)||0),r=tt(o),n=r-1,c=e[n],d=e[Math.min(n+1,e.length-1)],u=r===e.length,f=o-c,w=u?0:Math.max(0,d-o),m=u?1:Math.max(1,d-c),s=Math.max(0,Math.min(100,Math.round(f/m*100)));return{currentLevel:r,xpInLevel:f,xpToNext:w,percent:s}}function Tt({goodCount:t,advanced:e,flames:o}){let{XP_PER_GOOD:r,ADVANCED_MULT:n}=b.get(),c=(Number(t)||0)*r,d=e?n:1,u=(Number(o)||0)===0?1:Math.max(1,Number(o)),f=Math.round(c*d*u);return{base:c,multMode:d,multFlames:u,total:f}}function Pt(t,e){if(!t||!e)return!1;let o=d=>{let[u,f,w]=String(d).split("-").map(m=>Number(m));return Date.UTC(u,(f||1)-1,w||1)},r=o(t),n=o(e);return Math.floor(Math.abs(n-r)/864e5)>=2}function It(t,e){if(!t||!e||t.last_play_date===e)return t;let o=h({},t);return o.flames=Math.max(0,Number(o.flames)||0)+1,o.last_play_date=e,o}var Lt={levelFromXP:tt,progressInLevel:Ct,sessionXP:Tt,shouldResetFlames:Pt,applyDailyFlame:It},v=Lt;var g=null;function Dt(t,e){let o=Date.now();g={index:0,total:0,goodCount:0,mode:e==="advanced",chapterId:t||null,startedAt:o}}function At(t){g&&t&&(g.goodCount+=1)}function kt(){g&&(g.index+=1)}function Ft(t){g&&(g.total=Math.max(0,Number(t)||0))}function $t(){return g?h({},g):null}function Ot(t){if(!g)return null;let e=Date.now(),o={goodCount:g.goodCount,total:g.total,advanced:!!g.mode,chapterTitle:t||"",startedAt:g.startedAt,endedAt:e};try{sessionStorage.setItem("ps_session_summary_v1",JSON.stringify(o))}catch(n){}let r=h({},o);return g=null,r}var Ut={start:Dt,answer:At,next:kt,setTotal:Ft,getState:$t,finish:Ot},M=Ut;var et="[data-trainer-flames]";async function Bt(){let t=l(et);if(t)try{let e=await _.loadProfile();p(t,Number(e.flames)||0)}catch(e){p(t,"0")}}async function Rt(){let t=l(et);if(!t)return;let e=await _.loadProfile(),o=E.getUserTZ(),r=E.toYMDInTZ(Date.now(),o);Number(e.flames)>0&&v.shouldResetFlames(e.last_play_date,r)&&await _.patchProfile({flames:0});let n=await _.loadProfile();p(t,Number(n.flames)||0)}var qt={init:Bt,refresh:Rt},L=qt;function Vt(){try{let t=sessionStorage.getItem("ps_session_summary_v1");return t?JSON.parse(t):null}catch(t){return null}}async function Xt(){let t=l("[data-trainer-level-name]"),e=l("[data-trainer-level-bar]"),o=l("[data-trainer-level-fill]"),r=l("[data-trainer-level-percent]"),n=l("[data-trainer-play]"),c=l('[data-mode="simple"]'),d=l('[data-mode="advanced"]');if(!t&&!e&&!n)return;let u=await _.loadProfile(),{currentLevel:f,percent:w}=v.progressInLevel(u.xp_total);p(t,`Niveau ${f}`),P(o,w),p(r,`${w}%`);let m=[];try{m=await I.getChapters()}catch(i){}let s=l("[data-trainer-chapters]");if(s&&s.tagName==="SELECT")s.innerHTML="",m.forEach(i=>{let y=document.createElement("option");y.value=i.id,y.textContent=i.title||i.slug||i.id,s.appendChild(y)});else{let i=l("[data-trainer-chapters-list]");i&&(i.innerHTML="",m.forEach(y=>{let x=document.createElement("div");x.setAttribute("data-chapter-id",y.id),x.textContent=y.title||y.slug||y.id,i.appendChild(x)}))}let a="simple";N(c,"click",()=>{a="simple"}),N(d,"click",()=>{a="advanced"}),N(n,"click",()=>{let i=null;if(s&&s.tagName==="SELECT")i=s.value||null;else{let y=l("[data-trainer-chapters-list] [data-chapter-id].selected");i=y?y.getAttribute("data-chapter-id"):null}!i&&m[0]&&(i=m[0].id);try{sessionStorage.setItem("ps_lobby_choice_v1",JSON.stringify({chapterId:i,mode:a}))}catch(y){}window.location.href="/trainer/questions"})}async function Jt(){let t=l("[data-q-stem]"),e=A("[data-q-choice]"),o=l("[data-q-feedback]"),r=l("[data-q-correct]"),n=l("[data-q-next]");if(!t&&!n)return;let c=null;try{c=JSON.parse(sessionStorage.getItem("ps_lobby_choice_v1"))}catch(a){}if(!c||!c.chapterId){window.location.href="/trainer/lobby";return}let d=b.get();M.start(c.chapterId,c.mode);let u=[];try{u=await I.getQuestions({chapterId:c.chapterId,limit:d.QUESTION_COUNT})}catch(a){u=[]}if(!Array.isArray(u)||u.length===0){window.location.href="/trainer/lobby";return}M.setTotal(u.length);let f=0,w=!1;function m(a){if(!a)return;p(t,a.stem||"");let i=Array.isArray(a.choices)?a.choices:[];["A","B","C","D"].forEach((x,C)=>{let U=document.querySelector(`[data-q-choice="${x}"]`);U&&p(U,i[C]||"")}),o&&(o.style.display="none"),r&&p(r,""),w=!1}function s(a,i){var y;if(o){if(o.style.display="",p(o,i?"Bonne r\xE9ponse \u2705":"Mauvaise r\xE9ponse \u274C"),r){let x=Number(a.correctIndex),C=Array.isArray(a.choices)?a.choices:[];p(r,`Solution: ${(y=C[x])!=null?y:""}`)}w=!0}}["A","B","C","D"].forEach((a,i)=>{let y=document.querySelector(`[data-q-choice="${a}"]`);N(y,"click",()=>{if(w)return;let x=u[f],C=Number(x.correctIndex)===i;M.answer(C),s(x,C)})}),N(n,"click",()=>{var a;if(w){if(f+=1,M.next(),f>=u.length){let i=((a=u[0])==null?void 0:a.chapterTitle)||"";M.finish(i),window.location.href="/trainer/results";return}m(u[f])}}),m(u[f])}async function Zt(){let t=l("[data-r-score]"),e=l("[data-r-xp-base]"),o=l("[data-r-mult-flames]"),r=l("[data-r-mult-mode]"),n=l("[data-r-xp-total]"),c=l("[data-trainer-level-name]"),d=l("[data-trainer-level-fill]"),u=l("[data-trainer-level-percent]");if(!t&&!n&&!c)return;let f=Vt();if(!f){window.location.href="/trainer/lobby";return}let w=E.getUserTZ(),m=E.toYMDInTZ(Date.now(),w),s=await _.loadProfile();v.shouldResetFlames(s.last_play_date,m)&&(s=await _.patchProfile({flames:0})),_.isTodayCredited(s,m)||(s=await _.patchProfile({flames:Math.max(0,Number(s.flames)||0)+1,last_play_date:m}));let a=v.sessionXP({goodCount:f.goodCount,advanced:f.advanced,flames:s.flames}),i=Math.max(0,Number(s.xp_total)||0)+a.total,y=v.levelFromXP(i);s=await _.patchProfile({xp_total:i,level:y}),p(t,`${f.goodCount}/${f.total}`),p(e,`${a.base}`),p(o,`\xD7${a.multFlames}`),p(r,`\xD7${a.multMode}`),p(n,`${a.total}`);let x=v.progressInLevel(s.xp_total);p(c,`Niveau ${x.currentLevel}`),P(d,x.percent),p(u,`${x.percent}%`)}var Qt={initLobby:Xt,initQuestions:Jt,initResults:Zt},T=Qt;function zt(){document.addEventListener("DOMContentLoaded",async()=>{try{await L.init(),await L.refresh()}catch(t){}try{await T.initLobby()}catch(t){}try{await T.initQuestions()}catch(t){}try{await T.initResults()}catch(t){}})}var Gt={boot:zt},O=Gt;typeof window!="undefined"&&(window.PokerSciences=window.PokerSciences||{},window.PokerSciences.Trainer={Config:b,Utils:$,Time:E,Storage:_,Data:I,Progress:v,Session:M,Navbar:L,Pages:T,Boot:O});O.boot();})();
